#!/bin/bash
set -e

echo "üîç Running Programic PHP Linting Rules..."

# Detect project root (assumes this script is called via vendor/bin/lint)
PROJECT_ROOT="$(pwd)"

# Parse flags
ONLY=""
FIX=false
while [[ $# -gt 0 ]]; do
  case "$1" in
    --only)
      ONLY="$2"
      shift 2
      ;;
    --fix)
      FIX=true
      shift
      ;;
    *)
      echo "‚ùå Unknown option: $1"
      exit 1
      ;;
  esac
done

# Helper to check if a tool is in the comma-separated --only list
should_run() {
  [[ -z "$ONLY" || ",$ONLY," == *",$1,"* ]]
}

# Run TLint
if should_run "tlint"; then
  echo "üß™ Running TLint..."

  if [ "$FIX" = true ]; then
    vendor/bin/tlint format
  else
    vendor/bin/tlint
  fi
fi

# Run PHPStan
if should_run "phpstan"; then
  if [ -f "$PROJECT_ROOT/phpstan.neon" ]; then
    echo "üîé Running PHPStan with project config..."
    vendor/bin/phpstan analyse
  else
    echo "üîé Running PHPStan with default config..."
    vendor/bin/phpstan analyse -c vendor/programic/php-linting-rules/configs/phpstan.neon
  fi
fi

# Run PHPMD
if should_run "phpmd"; then
  if [ -f "$PROJECT_ROOT/phpmd.xml" ]; then
    echo "üîé Running PHPMD with project config..."
    vendor/bin/phpmd . text "$PROJECT_ROOT/phpmd.xml" --exclude storage/*,vendor/*
  else
    echo "üîé Running PHPMD with default config..."
    vendor/bin/phpmd . text vendor/programic/php-linting-rules/configs/phpmd.xml --exclude storage/*,vendor/*
  fi
fi

# Run PHPMD
# Run ECS
if should_run "ecs"; then
  if [ -f "$PROJECT_ROOT/ecs.php" ]; then
    echo "üîé Running ECS with project config..."
    CMD="vendor/bin/ecs --config=$PROJECT_ROOT/ecs.php"
  else
    echo "üîé Running ECS with default config..."
    CMD="vendor/bin/ecs --config=vendor/programic/php-linting-rules/configs/ecs.php"
  fi

  if [ "$FIX" = true ]; then
    CMD="$CMD --fix"
  fi

  eval "$CMD"
fi
